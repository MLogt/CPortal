<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <title>Klantportal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 16px;
      background: #f5f5f7;
      color: #222;
    }

    h1, h2 {
      margin-top: 0;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: #fff;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(15, 23, 42, 0.08);
    }

    .inventory {
      font-weight: 600;
      font-size: 18px;
      margin-bottom: 12px;
    }

    .meta {
      font-size: 13px;
      color: #666;
      margin-bottom: 24px;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 8px;
      font-size: 14px;
    }

    th, td {
      border: 1px solid #e5e7eb;
      padding: 8px;
      vertical-align: top;
    }

    th {
      background: #f9fafb;
      text-align: left;
      font-weight: 600;
    }

    tr:nth-child(even) td {
      background: #fcfcfd;
    }

    .status-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 12px;
      text-transform: capitalize;
    }

    .status-reserved {
      background: #fef3c7;
      color: #92400e;
    }

    .status-paid {
      background: #dcfce7;
      color: #166534;
    }

    .status-shipped {
      background: #dbeafe;
      color: #1d4ed8;
    }

    .status-cancelled {
      background: #fee2e2;
      color: #b91c1c;
    }

    form {
      margin-top: 16px;
      padding: 16px;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
    }

    label {
      display: block;
      font-size: 14px;
      margin-bottom: 4px;
      font-weight: 500;
    }

    input[type="text"],
    input[type="number"],
    textarea {
      width: 100%;
      box-sizing: border-box;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      font-size: 14px;
      font-family: inherit;
    }

    textarea {
      resize: vertical;
      min-height: 60px;
    }

    .field {
      margin-bottom: 12px;
    }

    .checkbox-row {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      font-size: 13px;
      margin: 8px 0 16px;
    }

    .checkbox-row input[type="checkbox"] {
      margin-top: 3px;
    }

    button[type="submit"] {
      background: #111827;
      color: #fff;
      border: none;
      padding: 10px 16px;
      border-radius: 999px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
    }

    button[type="submit"]:disabled {
      opacity: 0.6;
      cursor: default;
    }

    .message {
      margin-top: 8px;
      font-size: 13px;
    }

    .message.error {
      color: #b91c1c;
    }

    .message.success {
      color: #166534;
    }

    .loading {
      font-size: 14px;
      color: #6b7280;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Klantportal</h1>
    <p class="meta">
      Deze pagina toont jouw gereserveerde voorraad en eerdere orders. 
      Het plaatsen van een order via dit formulier geldt als afnameverplichting.
    </p>

    <div id="inventory" class="inventory">Voorraad laden…</div>
    <div id="inventory-meta" class="meta"></div>

    <h2>Orders</h2>
    <div id="orders-loading" class="loading">Orders laden…</div>
    <table id="orders-table" style="display:none;">
      <thead>
        <tr>
          <th>Datum</th>
          <th>Besteld door</th>
          <th>Klant</th>
          <th>Aantal (kg)</th>
          <th>Status</th>
          <th>Opmerking</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <h2>Nieuwe order</h2>
    <form id="order-form">
      <div class="field">
        <label for="ordered_by">Besteld door</label>
        <input id="ordered_by" name="ordered_by" type="text" required />
      </div>

      <div class="field">
        <label for="quantity_kg">Aantal (kg)</label>
        <input
          id="quantity_kg"
          name="quantity_kg"
          type="number"
          min="1"
          step="1"
          required
        />
      </div>

      <div class="field">
        <label for="comment">Opmerking (optioneel)</label>
        <textarea id="comment" name="comment"></textarea>
      </div>

      <div class="checkbox-row">
        <input id="commitment" name="commitment" type="checkbox" required />
        <label for="commitment">
          Ik ga een afnameverplichting aan voor het hierboven ingevulde aantal.
        </label>
      </div>

      <button type="submit">Order plaatsen</button>
      <div id="form-message" class="message"></div>
    </form>
  </div>

  <script>
    // ▼▼▼ PAS DIT AAN NAAR JOUW APPS SCRIPT WEB APP URL ▼▼▼
    const API_BASE = "https://script.google.com/macros/s/AKfycbzkOx-GwMl8k6uiBIjD7DCNSRJdB5n0M9cFQagsEp7NG1v0KhbOa2AUy5k6MRfmwoPP/exec"; // bv. https://script.google.com/macros/s/XYZ/exec
    // ▲▲▲ PAS DIT AAN ▲▲▲

    const CUSTOMER_ID = 1; // zelfde als in Apps Script configuratie

    async function loadDashboard() {
      const inventoryEl = document.getElementById("inventory");
      const inventoryMetaEl = document.getElementById("inventory-meta");
      const ordersLoadingEl = document.getElementById("orders-loading");
      const ordersTableEl = document.getElementById("orders-table");
      const tbody = ordersTableEl.querySelector("tbody");

      inventoryEl.textContent = "Voorraad laden…";
      inventoryMetaEl.textContent = "";
      ordersLoadingEl.style.display = "block";
      ordersTableEl.style.display = "none";
      tbody.innerHTML = "";

      try {
        const res = await fetch(
          `${API_BASE}?action=dashboard&customer_id=${encodeURIComponent(
            CUSTOMER_ID
          )}`
        );
        const data = await res.json();

        if (!data.success) {
          throw new Error(data.error || "Onbekende fout bij dashboard");
        }

        // Voorraad
        if (!data.inventory) {
          inventoryEl.textContent = "Geen voorraad gevonden.";
        } else {
          inventoryEl.textContent =
            "Beschikbare voorraad: " + data.inventory.available_kg + " kg";

          if (data.inventory.updated_at) {
            const dt = new Date(data.inventory.updated_at);
            if (!isNaN(dt)) {
              inventoryMetaEl.textContent =
                "Laatst bijgewerkt: " + dt.toLocaleString("nl-NL");
            }
          }
        }

        // Orders
        ordersLoadingEl.style.display = "none";

        const orders = data.orders || [];
        if (orders.length === 0) {
          ordersLoadingEl.style.display = "block";
          ordersLoadingEl.textContent = "Er zijn nog geen orders geplaatst.";
          return;
        }

        ordersTableEl.style.display = "table";
        orders.forEach((order) => {
          const tr = document.createElement("tr");
          const d = new Date(order.timestamp);
          const dateText = isNaN(d)
            ? order.timestamp
            : d.toLocaleDateString("nl-NL");

          const status = (order.status || "").toLowerCase();
          const statusClass = status
            ? "status-badge status-" + status
            : "status-badge";

          tr.innerHTML = `
            <td>${dateText}</td>
            <td>${order.ordered_by || ""}</td>
            <td>${order.customer || ""}</td>
            <td>${order.quantity_kg || ""}</td>
            <td><span class="${statusClass}">${status || ""}</span></td>
            <td>${order.comment ? escapeHtml(order.comment) : ""}</td>
          `;
          tbody.appendChild(tr);
        });
      } catch (err) {
        inventoryEl.textContent =
          "Er ging iets mis bij het ophalen van de gegevens.";
        console.error(err);
        ordersLoadingEl.textContent =
          "Er ging iets mis bij het laden van de orders.";
      }
    }

    function escapeHtml(text) {
      return String(text)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    document
      .getElementById("order-form")
      .addEventListener("submit", async (e) => {
        e.preventDefault();

        const form = e.target;
        const messageEl = document.getElementById("form-message");
        const submitBtn = form.querySelector('button[type="submit"]');

        messageEl.textContent = "";
        messageEl.className = "message";
        submitBtn.disabled = true;

        const orderedBy = form.ordered_by.value.trim();
        const quantity = Number(form.quantity_kg.value);
        const comment = form.comment.value.trim();
        const commitmentChecked = form.commitment.checked;

        if (!commitmentChecked) {
          messageEl.textContent =
            "Je moet akkoord gaan met de afnameverplichting.";
          messageEl.classList.add("error");
          submitBtn.disabled = false;
          return;
        }

        if (!orderedBy || !quantity || quantity <= 0) {
          messageEl.textContent =
            "Vul een geldige naam en hoeveelheid in.";
          messageEl.classList.add("error");
          submitBtn.disabled = false;
          return;
        }

        try {
          const res = await fetch(API_BASE, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              customer_id: CUSTOMER_ID,
              ordered_by: orderedBy,
              quantity_kg: quantity,
              comment: comment,
            }),
          });

          const data = await res.json();

          if (!res.ok || !data.success) {
            throw new Error(data.error || "Order kon niet worden aangemaakt.");
          }

          messageEl.textContent =
            "Order verstuurd. Dit is een afnameverplichting.";
          messageEl.classList.add("success");
          form.reset();

          // dashboard opnieuw laden (voorraad + orders)
          await loadDashboard();
        } catch (err) {
          console.error(err);
          messageEl.textContent =
            "Er ging iets mis bij het versturen van de order: " + err.message;
          messageEl.classList.add("error");
        } finally {
          submitBtn.disabled = false;
        }
      });

    // start
    loadDashboard();
  </script>
</body>
</html>
