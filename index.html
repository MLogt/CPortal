<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>HDPro Customer Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 16px;
      background: #f5f5f7;
      color: #222;
    }

    h1, h2, h3 {
      margin-top: 0;
    }

    .container {
      max-width: 1100px;
      margin: 0 auto;
      background: #fff;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(15, 23, 42, 0.08);
    }

    .inventory {
      font-weight: 600;
      font-size: 18px;
      margin-bottom: 8px;
    }

    .meta {
      font-size: 13px;
      color: #666;
      margin-bottom: 16px;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 8px;
      font-size: 14px;
    }

    th, td {
      border: 1px solid #e5e7eb;
      padding: 8px;
      vertical-align: top;
    }

    th {
      background: #f9fafb;
      text-align: left;
      font-weight: 600;
    }

    tr:nth-child(even) td {
      background: #fcfcfd;
    }

    .status-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 12px;
      text-transform: capitalize;
    }

    .status-reserved {
      background: #fef3c7;
      color: #92400e;
    }

    .status-paid {
      background: #dcfce7;
      color: #166534;
    }

    .status-shipped {
      background: #dbeafe;
      color: #1d4ed8;
    }

    .status-cancelled {
      background: #fee2e2;
      color: #b91c1c;
    }

    form {
      margin-top: 16px;
      padding: 16px;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
    }

    label {
      display: block;
      font-size: 14px;
      margin-bottom: 4px;
      font-weight: 500;
    }

    input[type="text"],
    input[type="number"],
    input[type="date"],
    select,
    textarea {
      width: 100%;
      box-sizing: border-box;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      font-size: 14px;
      font-family: inherit;
    }

    textarea {
      resize: vertical;
      min-height: 60px;
    }

    .field {
      margin-bottom: 12px;
    }

    .checkbox-row {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      font-size: 13px;
      margin: 8px 0 16px;
    }

    .checkbox-row input[type="checkbox"] {
      margin-top: 3px;
    }

    button[type="submit"] {
      background: #111827;
      color: #fff;
      border: none;
      padding: 10px 16px;
      border-radius: 999px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
    }

    button[type="submit"]:disabled {
      opacity: 0.6;
      cursor: default;
    }

    .message {
      margin-top: 8px;
      font-size: 13px;
    }

    .message.error {
      color: #b91c1c;
    }

    .message.success {
      color: #166534;
    }

    .loading {
      font-size: 14px;
      color: #6b7280;
    }

    .two-columns {
      display: grid;
      grid-template-columns: minmax(0, 3fr) minmax(0, 2fr);
      gap: 24px;
      margin-top: 24px;
    }

    .card {
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      padding: 16px;
      background: #f9fafb;
      font-size: 14px;
    }

    .price-table {
      margin-top: 8px;
      font-size: 13px;
    }

    .price-table th,
    .price-table td {
      font-size: 13px;
    }

    .highlight {
      font-weight: 600;
    }

    .inline {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .inline > * {
      flex: 1;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>HDPro Customer Portal</h1>
    <p class="meta">
      Dedicated order portal for HDPro between DBF and CEAD. Placing an order here
      reserves material and creates a binding purchase commitment.
    </p>

    <div class="two-columns">
      <div>
        <div id="inventory" class="inventory">Loading inventory…</div>
        <div id="inventory-meta" class="meta"></div>

        <h2>Orders</h2>
        <div id="orders-loading" class="loading">Loading orders…</div>
        <table id="orders-table" style="display:none;">
          <thead>
            <tr>
              <th>Date</th>
              <th>Ordered by</th>
              <th>Customer</th>
              <th>Quantity (kg)</th>
              <th>Bags</th>
              <th>Pallets</th>
              <th>Status</th>
              <th>Planned shipping</th>
              <th>Shipped date</th>
              <th>Comment</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div>
        <h2>New order</h2>
        <form id="order-form">
          <div class="field">
            <label for="ordered_by_select">Ordered by</label>
            <select id="ordered_by_select" name="ordered_by_select" required>
              <option value="">Select a name…</option>
              <option value="Andrea">Andrea</option>
              <option value="Hugo">Hugo</option>
              <option value="Bob">Bob</option>
              <option value="Fabien">Fabien</option>
              <option value="Maarten 4">Maarten 4</option>
              <option value="Lucas">Lucas</option>
              <option value="Other">Other</option>
            </select>
          </div>

          <div class="field" id="ordered_by_other_field" style="display:none;">
            <label for="ordered_by_other">Other name</label>
            <input id="ordered_by_other" name="ordered_by_other" type="text" />
          </div>

          <div class="field">
            <label for="customer_name">Customer name</label>
            <input
              id="customer_name"
              name="customer_name"
              type="text"
              placeholder="e.g. Klant BV, CEAD…"
              required
            />
          </div>

          <div class="field">
            <label for="quantity_kg">Quantity (kg)</label>
            <input
              id="quantity_kg"
              name="quantity_kg"
              type="number"
              min="20"
              step="20"
              required
            />
          </div>

          <div class="field">
            <label for="planned_shipping_date">Planned shipping date</label>
            <input
              id="planned_shipping_date"
              name="planned_shipping_date"
              type="date"
            />
          </div>

          <div class="meta" id="quantity-summary">
            Enter a multiple of 20 kg. We deliver in 20 kg bags (24 bags per euro pallet).
          </div>

          <div class="meta" id="price-summary"></div>

          <div class="field">
            <label for="comment">Comment (optional)</label>
            <textarea id="comment" name="comment"></textarea>
          </div>

          <div class="checkbox-row">
            <input id="commitment" name="commitment" type="checkbox" required />
            <label for="commitment">
              I confirm this order and understand that it creates a binding purchase commitment.
            </label>
          </div>

          <button type="submit" id="submit-btn" disabled>Place order</button>
          <div id="form-message" class="message"></div>
        </form>
      </div>
    </div>

    <div class="two-columns" style="margin-top:32px;">
      <div class="card">
        <h2>Pricing</h2>
        <p class="meta">
          All prices are EXW (Ex Works) and exclusive of VAT. Prices are per kg based on
          the total ordered quantity.
        </p>

        <table class="price-table">
          <thead>
            <tr>
              <th>Range (kg)</th>
              <th>Minimal customer price<br/>(€ / kg)</th>
              <th>CEAD price<br/>(€ / kg)</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>0 – 400</td>
              <td>9.90</td>
              <td>8.28</td>
            </tr>
            <tr>
              <td>401 – 1200</td>
              <td>9.50</td>
              <td>8.08</td>
            </tr>
            <tr>
              <td>1201 – 5200</td>
              <td>8.80</td>
              <td>7.73</td>
            </tr>
            <tr>
              <td>&gt; 5200</td>
              <td>8.30</td>
              <td>7.48</td>
            </tr>
          </tbody>
        </table>

        <p id="price-preview" class="meta"></p>
      </div>

      <div class="card">
        <h2>Information</h2>
        <p>
          This is the dedicated CEAD order portal for HDPro between DBF and CEAD.
          Once an order is committed in this system, material is reserved and a
          purchase commitment is created.
        </p>
        <p>
          Payment is required before shipping. Shipping is handled by CEAD, by
          appointment. DBF will prepare the shipments for CEAD; CEAD arranges the
          physical shipment and logistics.
        </p>
        <p>
          If you made a mistake or need to change an order, please email Maarten.
        </p>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = "https://script.google.com/macros/s/AKfycbzkOx-GwMl8k6uiBIjD7DCNSRJdB5n0M9cFQagsEp7NG1v0KhbOa2AUy5k6MRfmwoPP/exec";
    const CUSTOMER_ID = 1;

    const BAG_WEIGHT_KG = 20;
    const BAGS_PER_PALLET = 24;

    function getCustomerUnitPrice(kg) {
      if (kg <= 400) return 9.90;
      if (kg <= 1200) return 9.50;
      if (kg <= 5200) return 8.80;
      return 8.30;
    }

    function getCeadUnitPrice(kg) {
      if (kg <= 400) return 8.28;
      if (kg <= 1200) return 8.08;
      if (kg <= 5200) return 7.73;
      return 7.48;
    }

    function computePackaging(kg) {
      if (!kg || kg <= 0) return { bags: 0, pallets: 0 };
      const bags = Math.round(kg / BAG_WEIGHT_KG);
      const pallets = Math.ceil(bags / BAGS_PER_PALLET);
      return { bags, pallets };
    }

    function formatEuro(value) {
      return "€ " + value.toFixed(2);
    }

    function formatDate(value) {
      if (!value) return "";
      const d = new Date(value);
      if (isNaN(d)) return value;
      return d.toLocaleDateString("en-GB");
    }

    async function loadDashboard() {
      const inventoryEl = document.getElementById("inventory");
      const inventoryMetaEl = document.getElementById("inventory-meta");
      const ordersLoadingEl = document.getElementById("orders-loading");
      const ordersTableEl = document.getElementById("orders-table");
      const tbody = ordersTableEl.querySelector("tbody");

      inventoryEl.textContent = "Loading inventory…";
      inventoryMetaEl.textContent = "";
      ordersLoadingEl.style.display = "block";
      ordersTableEl.style.display = "none";
      tbody.innerHTML = "";

      try {
        const res = await fetch(
          `${API_BASE}?action=dashboard&customer_id=${encodeURIComponent(
            CUSTOMER_ID
          )}`
        );
        const data = await res.json();

        if (!data.success) {
          throw new Error(data.error || "Unknown dashboard error");
        }

        // Inventory
        if (!data.inventory) {
          inventoryEl.textContent = "No inventory found.";
        } else {
          inventoryEl.textContent =
            "Available inventory: " + data.inventory.available_kg + " kg";

          if (data.inventory.updated_at) {
            const dt = new Date(data.inventory.updated_at);
            if (!isNaN(dt)) {
              inventoryMetaEl.textContent =
                "Last updated: " + dt.toLocaleString("en-GB");
            }
          }
        }

        // Orders
        ordersLoadingEl.style.display = "none";

        const orders = data.orders || [];
        if (orders.length === 0) {
          ordersLoadingEl.style.display = "block";
          ordersLoadingEl.textContent = "No orders placed yet.";
          return;
        }

        ordersTableEl.style.display = "table";
        orders.forEach((order) => {
          const tr = document.createElement("tr");
          const d = new Date(order.timestamp);
          const dateText = isNaN(d)
            ? order.timestamp
            : d.toLocaleDateString("en-GB");

          const status = (order.status || "").toLowerCase();
          const statusClass = status
            ? "status-badge status-" + status
            : "status-badge";

          const bags = order.bags ?? computePackaging(order.quantity_kg).bags;
          const pallets =
            order.pallets ?? computePackaging(order.quantity_kg).pallets;

          const planned = formatDate(order.planned_shipping_date);
          const shipped = formatDate(order.shipped_date);

          tr.innerHTML = `
            <td>${dateText}</td>
            <td>${order.ordered_by || ""}</td>
            <td>${order.customer || ""}</td>
            <td>${order.quantity_kg || ""}</td>
            <td>${bags}</td>
            <td>${pallets}</td>
            <td><span class="${statusClass}">${status || ""}</span></td>
            <td>${planned}</td>
            <td>${shipped}</td>
            <td>${order.comment ? escapeHtml(order.comment) : ""}</td>
          `;
          tbody.appendChild(tr);
        });
      } catch (err) {
        inventoryEl.textContent =
          "Something went wrong while loading data.";
        console.error(err);
        ordersLoadingEl.textContent =
          "Something went wrong while loading orders.";
      }
    }

    function escapeHtml(text) {
      return String(text)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function updateQuantityInfo() {
      const qtyInput = document.getElementById("quantity_kg");
      const qty = Number(qtyInput.value);
      const summaryEl = document.getElementById("quantity-summary");
      const priceSummaryEl = document.getElementById("price-summary");
      const pricePreviewEl = document.getElementById("price-preview");
      const submitBtn = document.getElementById("submit-btn");

      let validQuantity = false;

      if (!qty || qty <= 0) {
        summaryEl.textContent =
          "Enter a multiple of 20 kg. We deliver in 20 kg bags (24 bags per euro pallet).";
        priceSummaryEl.textContent = "";
        pricePreviewEl.textContent = "";
      } else if (qty % BAG_WEIGHT_KG !== 0) {
        summaryEl.textContent =
          "Quantity must be a multiple of 20 kg. For example: 400, 720, 1200…";
        priceSummaryEl.textContent = "";
        pricePreviewEl.textContent = "";
      } else {
        validQuantity = true;
        const pkg = computePackaging(qty);
        summaryEl.textContent = `${qty} kg = ${pkg.bags} bags, fits on ${pkg.pallets} euro pallet${pkg.pallets === 1 ? "" : "s"}.`;

        const custUnit = getCustomerUnitPrice(qty);
        const ceadUnit = getCeadUnitPrice(qty);
        const custTotal = custUnit * qty;
        const ceadTotal = ceadUnit * qty;

        const text =
          `For ${qty} kg: minimal customer price is ${formatEuro(custUnit)} / kg (${formatEuro(custTotal)} total), ` +
          `CEAD price is ${formatEuro(ceadUnit)} / kg (${formatEuro(ceadTotal)} total).`;

        priceSummaryEl.textContent = text;
        pricePreviewEl.textContent = text;
      }

      // knop alleen aan als quantity geldig is
      submitBtn.disabled = !validQuantity;
    }

    function updateOrderedByUI() {
      const select = document.getElementById("ordered_by_select");
      const otherField = document.getElementById("ordered_by_other_field");
      const otherInput = document.getElementById("ordered_by_other");

      if (select.value === "Other") {
        otherField.style.display = "block";
        otherInput.required = true;
      } else {
        otherField.style.display = "none";
        otherInput.required = false;
        otherInput.value = "";
      }
    }

    document
      .getElementById("quantity_kg")
      .addEventListener("input", updateQuantityInfo);

    document
      .getElementById("ordered_by_select")
      .addEventListener("change", updateOrderedByUI);

    document
      .getElementById("order-form")
      .addEventListener("submit", async (e) => {
        e.preventDefault();

        const form = e.target;
        const messageEl = document.getElementById("form-message");
        const submitBtn = document.getElementById("submit-btn");

        messageEl.textContent = "";
        messageEl.className = "message";
        submitBtn.disabled = true;

        const orderedBySelect = form.ordered_by_select.value;
        const orderedByOther = form.ordered_by_other.value.trim();
        const customerName = form.customer_name.value.trim();
        const quantity = Number(form.quantity_kg.value);
        const comment = form.comment.value.trim();
        const plannedShippingDate = form.planned_shipping_date.value; // YYYY-MM-DD
        const commitmentChecked = form.commitment.checked;

        let orderedBy = orderedBySelect;
        if (orderedBySelect === "Other") {
          orderedBy = orderedByOther;
        }

        if (!orderedBy) {
          messageEl.textContent =
            "Please select or enter a name in 'Ordered by'.";
          messageEl.classList.add("error");
          submitBtn.disabled = false;
          return;
        }

        if (!customerName) {
          messageEl.textContent =
            "Please enter a customer name.";
          messageEl.classList.add("error");
          submitBtn.disabled = false;
          return;
        }

        if (!commitmentChecked) {
          messageEl.textContent =
            "You must agree to the purchase commitment.";
          messageEl.classList.add("error");
          submitBtn.disabled = false;
          return;
        }

        if (!quantity || quantity <= 0 || quantity % BAG_WEIGHT_KG !== 0) {
          messageEl.textContent =
            "Quantity must be a valid multiple of 20 kg.";
          messageEl.classList.add("error");
          submitBtn.disabled = false;
          return;
        }

        try {
          const payloadObj = {
            customer_id: CUSTOMER_ID,
            ordered_by: orderedBy,
            customer_name: customerName,
            quantity_kg: quantity,
            comment: comment,
            planned_shipping_date: plannedShippingDate,
          };

          const res = await fetch(API_BASE, {
            method: "POST",
            body: new URLSearchParams({
              payload: JSON.stringify(payloadObj),
            }),
          });

          const text = await res.text();
          let data;
          try {
            data = JSON.parse(text);
          } catch (parseErr) {
            throw new Error("Unexpected response from server: " + text.slice(0, 120));
          }

          if (!res.ok || !data.success) {
            throw new Error(data.error || "Order could not be created.");
          }

          messageEl.textContent =
            "Order submitted. This is a binding purchase commitment.";
          messageEl.classList.add("success");
          form.reset();
          updateOrderedByUI();
          updateQuantityInfo();

          await loadDashboard();
        } catch (err) {
          console.error(err);
          messageEl.textContent =
            "Something went wrong while submitting the order: " + err.message;
          messageEl.classList.add("error");
        } finally {
          // quantity-validatie opnieuw bepalen
          updateQuantityInfo();
        }
      });

    // initial load
    loadDashboard();
    updateOrderedByUI();
    updateQuantityInfo();
  </script>
</body>
</html>
